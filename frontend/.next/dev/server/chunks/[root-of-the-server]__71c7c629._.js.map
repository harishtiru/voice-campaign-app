{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 50, "column": 0}, "map": {"version":3,"sources":["file:///home/test/voice-campaign-app/frontend/pages/api/upload.js"],"sourcesContent":["import nextConnect from \"next-connect\";\nimport multer from \"multer\";\nimport { parse } from \"csv-parse/sync\";\nimport { MongoClient } from \"mongodb\";\n\nconst upload = multer({ storage: multer.memoryStorage() });\n\nconst handler = nextConnect({\n  onError(err, req, res) {\n    console.error(err);\n    res.status(500).json({ error: err.message });\n  },\n  onNoMatch(req, res) {\n    res.status(405).json({ error: `Method ${req.method} not allowed` });\n  }\n});\n\nhandler.use(upload.single(\"file\"));\n\nhandler.post(async (req, res) => {\n  if (!req.file) return res.status(400).json({ error: \"No file uploaded\" });\n  const buffer = req.file.buffer;\n\n  let records;\n  try {\n    // parse CSV buffer to array of objects (header row required)\n    records = parse(buffer, { columns: true, skip_empty_lines: true, trim: true });\n  } catch (err) {\n    console.error(\"CSV parse error\", err);\n    return res.status(400).json({ error: \"CSV parse error: \" + err.message });\n  }\n\n  if (!Array.isArray(records) || records.length === 0) {\n    return res.json({ message: \"No rows\", count: 0 });\n  }\n\n  // add createdAt and optionally normalize phone field name (example: phone)\n  const docs = records.map(r => ({ ...r, createdAt: new Date() }));\n\n  const client = new MongoClient(process.env.MONGODB_URI);\n  try {\n    await client.connect();\n    const db = client.db(process.env.MONGO_DB || \"voice_campaign\");\n    const result = await db.collection(\"contacts\").insertMany(docs);\n    res.json({ message: \"Inserted\", count: result.insertedCount });\n  } catch (err) {\n    console.error(\"DB insert error\", err);\n    res.status(500).json({ error: err.message });\n  } finally {\n    await client.close();\n  }\n});\n\nexport const config = { api: { bodyParser: false } };\nexport default handler;\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;;;;;;AAEA,MAAM,SAAS,IAAA,gHAAM,EAAC;IAAE,SAAS,gHAAM,CAAC,aAAa;AAAG;AAExD,MAAM,UAAU,IAAA,yIAAW,EAAC;IAC1B,SAAQ,GAAG,EAAE,GAAG,EAAE,GAAG;QACnB,QAAQ,KAAK,CAAC;QACd,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO;QAAC;IAC5C;IACA,WAAU,GAAG,EAAE,GAAG;QAChB,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO,CAAC,OAAO,EAAE,IAAI,MAAM,CAAC,YAAY,CAAC;QAAC;IACnE;AACF;AAEA,QAAQ,GAAG,CAAC,OAAO,MAAM,CAAC;AAE1B,QAAQ,IAAI,CAAC,OAAO,KAAK;IACvB,IAAI,CAAC,IAAI,IAAI,EAAE,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;QAAE,OAAO;IAAmB;IACvE,MAAM,SAAS,IAAI,IAAI,CAAC,MAAM;IAE9B,IAAI;IACJ,IAAI;QACF,6DAA6D;QAC7D,UAAU,IAAA,iJAAK,EAAC,QAAQ;YAAE,SAAS;YAAM,kBAAkB;YAAM,MAAM;QAAK;IAC9E,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,mBAAmB;QACjC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO,sBAAsB,IAAI,OAAO;QAAC;IACzE;IAEA,IAAI,CAAC,MAAM,OAAO,CAAC,YAAY,QAAQ,MAAM,KAAK,GAAG;QACnD,OAAO,IAAI,IAAI,CAAC;YAAE,SAAS;YAAW,OAAO;QAAE;IACjD;IAEA,2EAA2E;IAC3E,MAAM,OAAO,QAAQ,GAAG,CAAC,CAAA,IAAK,CAAC;YAAE,GAAG,CAAC;YAAE,WAAW,IAAI;QAAO,CAAC;IAE9D,MAAM,SAAS,IAAI,sHAAW,CAAC,QAAQ,GAAG,CAAC,WAAW;IACtD,IAAI;QACF,MAAM,OAAO,OAAO;QACpB,MAAM,KAAK,OAAO,EAAE,CAAC,QAAQ,GAAG,CAAC,QAAQ,IAAI;QAC7C,MAAM,SAAS,MAAM,GAAG,UAAU,CAAC,YAAY,UAAU,CAAC;QAC1D,IAAI,IAAI,CAAC;YAAE,SAAS;YAAY,OAAO,OAAO,aAAa;QAAC;IAC9D,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,mBAAmB;QACjC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO;QAAC;IAC5C,SAAU;QACR,MAAM,OAAO,KAAK;IACpB;AACF;AAEO,MAAM,SAAS;IAAE,KAAK;QAAE,YAAY;IAAM;AAAE;uCACpC"}}]
}